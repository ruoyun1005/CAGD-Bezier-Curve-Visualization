(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();function l(o,t){return{x:o.x+t.x,y:o.y+t.y}}function v(o,t){return{x:o.x-t.x,y:o.y-t.y}}function f(o,t){return{x:o.x*t,y:o.y*t}}function b(o,t){return Math.hypot(o.x-t.x,o.y-t.y)}function p(o,t){const e=o.x-t.x,s=o.y-t.y;return e*e+s*s}function x(o){return o.x*o.x+o.y*o.y}function m(o){const t=Math.hypot(o.x,o.y)||1;return{x:o.x/t,y:o.y/t}}function E(o,t,e){return Math.max(t,Math.min(e,o))}function L(o){const t=o.getContext("2d");function e(){t.clearRect(0,0,o.width,o.height)}function s(){t.save(),t.globalAlpha=.35,t.lineWidth=1,t.strokeStyle="#1d2448";for(let h=0;h<=o.width;h+=50)t.beginPath(),t.moveTo(h,0),t.lineTo(h,o.height),t.stroke();for(let h=0;h<=o.height;h+=50)t.beginPath(),t.moveTo(0,h),t.lineTo(o.width,h),t.stroke();t.restore()}function n(h,d=3,c="#7aa2ff"){if(h.length){t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let a=1;a<h.length;a++)t.lineTo(h[a].x,h[a].y);t.lineWidth=d,t.strokeStyle=c,t.stroke()}}function i(h,d=2.2,c="#7aa2ff"){t.fillStyle=c;for(const a of h)t.beginPath(),t.arc(a.x,a.y,d,0,Math.PI*2),t.fill()}function r(h,d,c="#6ee7b7"){t.beginPath(),t.arc(h.x,h.y,d,0,Math.PI*2),t.fillStyle=c,t.fill()}return{ctx:t,clear:e,grid:s,polyline:n,points:i,circle:r}}class k{constructor(t){this.canvas=t,this.path=[],this.closed=!1,this.mode="add",this.dragging=null,this.last={x:0,y:0},this.shift=!1,this.showControls=!0,this.bindInput(),this.draw()}setMode(t){this.mode=t,this.draw()}toggleClosed(){this.path.length>=3&&(this.closed=!this.closed,this.draw())}clear(){console.log("CLEAR CALLED"),this.path=[],this.closed=!1,this.draw()}undo(){console.log("UNDO"),this.path.length>0&&(this.path.pop(),this.path.length<3&&(this.closed=!1),this.draw())}toggleControls(){this.showControls=!this.showControls,this.draw()}bindInput(){window.addEventListener("keydown",t=>{t.key==="Shift"&&(this.shift=!0)}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(this.shift=!1)}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("pointerdown",t=>{t.preventDefault();const e=this.pos(t);if(this.mode==="add"){const s=this.hitTest(e);if(s&&s.kind=="anchor"&&s.index===0&&this.path.length>=3){this.closed=!0,this.mode="edit",this.draw();return}s?this.dragging=s:this.addAnchor(e)}else this.dragging=this.hitTest(e);this.last=e,this.canvas.setPointerCapture(t.pointerId),this.draw()},{passive:!1}),this.canvas.addEventListener("pointermove",t=>{if(!this.dragging)return;t.preventDefault();const e=this.pos(t),s=e.x-this.last.x,n=e.y-this.last.y;if(this.last=e,this.dragging.kind==="anchor"){const i=this.path[this.dragging.index];i.p={x:i.p.x+s,y:i.p.y+n},i.in={x:i.in.x,y:i.in.y},i.out={x:i.out.x,y:i.out.y}}else if(this.dragging.kind==="in"){const i=this.path[this.dragging.index];i.in={x:i.in.x+s,y:i.in.y+n},i.smooth&&(i.out={x:-i.in.x,y:-i.in.y})}else if(this.dragging.kind==="out"){const i=this.path[this.dragging.index];i.out={x:i.out.x+s,y:i.out.y+n},i.smooth&&(i.in={x:-i.out.x,y:-i.out.y})}this.draw()},{passive:!1}),this.canvas.addEventListener("pointerup",t=>{this.dragging=null,this.canvas.releasePointerCapture(t.pointerId)}),this.canvas.addEventListener("dblclick",t=>{const e=this.pos(t),s=this.hitTest(e);if(s&&s.kind==="anchor"){const n=this.path[s.index];if(n.smooth=!n.smooth,n.smooth){const i=Math.max(x(n.in),x(n.out))**.5||40,r=m(l(n.out,f(n.in,-1)));n.out=f(r,i),n.in=f(r,-i)}this.draw()}else this.mode="edit"},{passive:!0})}addAnchor(t){if(this.path.length===0)this.path.push({p:t,in:{x:-40,y:0},out:{x:40,y:0},smooth:!0});else{const e=this.path[this.path.length-1],s=m(v(t,e.p)),n=E(b(e.p,t)*.3,30,120),i={p:t,in:f(s,-n),out:f(s,n),smooth:!0};e.smooth&&(e.out=f(s,n)),this.path.push(i)}}hitTest(t){const e=window.devicePixelRatio||1,n=window.innerWidth<=768?20:12,i=n*n*(e*e),r=n*.7*(n*.7)*(e*e);for(let h=this.path.length-1;h>=0;h--){const d=this.path[h];if(p(t,d.p)<=i)return{kind:"anchor",index:h};const c=l(d.p,d.in),a=l(d.p,d.out);if(p(t,c)<=r)return{kind:"in",index:h};if(p(t,a)<=r)return{kind:"out",index:h}}return null}draw(){const t=L(this.canvas),e=t.ctx;if(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.canvas.width,this.canvas.height),t.grid(),this.showControls){e.lineWidth=1.5;for(const s of this.path){const n=l(s.p,s.in),i=l(s.p,s.out);e.strokeStyle="#fca5a5",e.beginPath(),e.moveTo(s.p.x,s.p.y),e.lineTo(n.x,n.y),e.stroke(),e.beginPath(),e.moveTo(s.p.x,s.p.y),e.lineTo(i.x,i.y),e.stroke();const h=window.innerWidth<=768?5:4;t.circle(n,h,"#ffd6a5"),t.circle(i,h,"#ffd6a5")}}if(this.path.length>=2){e.lineWidth=3,e.strokeStyle="#7aa2ff",e.beginPath(),e.moveTo(this.path[0].p.x,this.path[0].p.y);for(let s=0;s<this.path.length-1;s++){const n=this.path[s],i=this.path[s+1],r=l(n.p,n.out),h=l(i.p,i.in);e.bezierCurveTo(r.x,r.y,h.x,h.y,i.p.x,i.p.y)}if(this.closed&&this.path.length>2){const s=this.path[this.path.length-1],n=this.path[0],i={x:s.p.x+s.out.x,y:s.p.y+s.out.y},r={x:n.p.x+n.in.x,y:n.p.y+n.in.y};e.bezierCurveTo(i.x,i.y,r.x,r.y,n.p.x,n.p.y)}e.stroke(),this.closed&&this.showControls&&(e.fillStyle="#9aa3c7",e.font="12px ui-sans-serif,system-ui",e.fillText("（已形成封閉路徑）",12,32))}if(this.showControls){const n=window.innerWidth<=768?8:6;for(const i of this.path)t.circle(i.p,n,"#6ee7b7")}e.fillStyle="#9aa3c7",e.font="18px ui-sans-serif,system-ui",e.fillText(`模式：${this.mode==="add"?"新增錨點":"編輯"}`,12,18),this.closed&&e.fillText("（已形成封閉路徑）",100,18)}redraw(){this.draw()}pos(t){const e=this.canvas.getBoundingClientRect();return{x:(t.clientX-e.left)*(this.canvas.width/e.width),y:(t.clientY-e.top)*(this.canvas.height/e.height)}}}const y=document.getElementById("canvas"),u=new k(y);document.getElementById("count");document.getElementById("mode-add").addEventListener("click",()=>u.setMode("add"));document.getElementById("mode-edit").addEventListener("click",()=>u.setMode("edit"));document.getElementById("undo").addEventListener("click",()=>u.undo());document.getElementById("clear").addEventListener("click",()=>u.clear());const g=document.getElementById("toggle-controls");g.addEventListener("click",()=>{u.toggleControls(),g.textContent=g.textContent==="HIDE HANDLES"?"SHOW HANDLES":"HIDE HANDLES"});function w(o,t){const e=window.devicePixelRatio||1,s=o.getBoundingClientRect(),n=Math.round(s.width*e),i=Math.round(s.height*e);(o.width!==n||o.height!==i)&&(o.width=n,o.height=i,t())}w(y,()=>u.redraw());window.addEventListener("resize",()=>w(y,()=>u.redraw()));
