(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();function a(o,t){return{x:o.x+t.x,y:o.y+t.y}}function v(o,t){return{x:o.x-t.x,y:o.y-t.y}}function l(o,t){return{x:o.x*t,y:o.y*t}}function E(o,t){return Math.hypot(o.x-t.x,o.y-t.y)}function g(o,t){const i=o.x-t.x,s=o.y-t.y;return i*i+s*s}function x(o){return o.x*o.x+o.y*o.y}function m(o){const t=Math.hypot(o.x,o.y)||1;return{x:o.x/t,y:o.y/t}}function L(o,t,i){return Math.max(t,Math.min(i,o))}function k(o){const t=o.getContext("2d");function i(){t.clearRect(0,0,o.width,o.height)}function s(){t.save(),t.globalAlpha=.35,t.lineWidth=1,t.strokeStyle="#1d2448";for(let h=0;h<=o.width;h+=50)t.beginPath(),t.moveTo(h,0),t.lineTo(h,o.height),t.stroke();for(let h=0;h<=o.height;h+=50)t.beginPath(),t.moveTo(0,h),t.lineTo(o.width,h),t.stroke();t.restore()}function n(h,u=3,f="#7aa2ff"){if(h.length){t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let d=1;d<h.length;d++)t.lineTo(h[d].x,h[d].y);t.lineWidth=u,t.strokeStyle=f,t.stroke()}}function e(h,u=2.2,f="#7aa2ff"){t.fillStyle=f;for(const d of h)t.beginPath(),t.arc(d.x,d.y,u,0,Math.PI*2),t.fill()}function r(h,u,f="#6ee7b7"){t.beginPath(),t.arc(h.x,h.y,u,0,Math.PI*2),t.fillStyle=f,t.fill()}return{ctx:t,clear:i,grid:s,polyline:n,points:e,circle:r}}class C{constructor(t){this.canvas=t,this.path=[],this.closed=!1,this.mode="add",this.dragging=null,this.last={x:0,y:0},this.shift=!1,this.showControls=!0,this.bindInput(),this.draw()}setMode(t){this.mode=t,this.draw()}toggleClosed(){this.path.length>=3&&(this.closed=!this.closed,this.draw())}clear(){console.log("CLEAR CALLED"),this.path=[],this.closed=!1,this.draw()}undo(){console.log("UNDO"),this.path.length>0&&(this.path.pop(),this.path.length<3&&(this.closed=!1),this.draw())}toggleControls(){this.showControls=!this.showControls,this.draw()}bindInput(){window.addEventListener("keydown",t=>{t.key==="Shift"&&(this.shift=!0)}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(this.shift=!1)}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("pointerdown",t=>{const i=this.pos(t);if(this.mode==="add"){const s=this.hitTest(i);if(s&&s.kind=="anchor"&&s.index===0&&this.path.length>=3){this.closed=!0,this.mode="edit",this.draw();return}s?this.dragging=s:this.addAnchor(i)}else this.dragging=this.hitTest(i);this.last=i,this.canvas.setPointerCapture(t.pointerId),this.draw()}),this.canvas.addEventListener("pointermove",t=>{if(!this.dragging)return;const i=this.pos(t),s=i.x-this.last.x,n=i.y-this.last.y;if(this.last=i,this.dragging.kind==="anchor"){const e=this.path[this.dragging.index];e.p={x:e.p.x+s,y:e.p.y+n},e.in={x:e.in.x,y:e.in.y},e.out={x:e.out.x,y:e.out.y}}else if(this.dragging.kind==="in"){const e=this.path[this.dragging.index];e.in={x:e.in.x+s,y:e.in.y+n},e.smooth&&(e.out={x:-e.in.x,y:-e.in.y})}else if(this.dragging.kind==="out"){const e=this.path[this.dragging.index];e.out={x:e.out.x+s,y:e.out.y+n},e.smooth&&(e.in={x:-e.out.x,y:-e.out.y})}this.draw()}),this.canvas.addEventListener("pointerup",t=>{this.dragging=null,this.canvas.releasePointerCapture(t.pointerId)}),this.canvas.addEventListener("dblclick",t=>{const i=this.pos(t),s=this.hitTest(i);if(s&&s.kind==="anchor"){const n=this.path[s.index];if(n.smooth=!n.smooth,n.smooth){const e=Math.max(x(n.in),x(n.out))**.5||40,r=m(a(n.out,l(n.in,-1)));n.out=l(r,e),n.in=l(r,-e)}this.draw()}else this.mode="edit"},{passive:!0})}addAnchor(t){if(this.path.length===0)this.path.push({p:t,in:{x:-40,y:0},out:{x:40,y:0},smooth:!0});else{const i=this.path[this.path.length-1],s=m(v(t,i.p)),n=L(E(i.p,t)*.3,30,120),e={p:t,in:l(s,-n),out:l(s,n),smooth:!0};i.smooth&&(i.out=l(s,n)),this.path.push(e)}}hitTest(t){for(let n=this.path.length-1;n>=0;n--){const e=this.path[n];if(g(t,e.p)<=81)return{kind:"anchor",index:n};const r=a(e.p,e.in),h=a(e.p,e.out);if(g(t,r)<=49)return{kind:"in",index:n};if(g(t,h)<=49)return{kind:"out",index:n}}return null}draw(){const t=k(this.canvas),i=t.ctx;if(i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,this.canvas.width,this.canvas.height),t.grid(),this.showControls){i.lineWidth=1.5;for(const s of this.path){const n=a(s.p,s.in),e=a(s.p,s.out);i.strokeStyle="#fca5a5",i.beginPath(),i.moveTo(s.p.x,s.p.y),i.lineTo(n.x,n.y),i.stroke(),i.beginPath(),i.moveTo(s.p.x,s.p.y),i.lineTo(e.x,e.y),i.stroke(),t.circle(n,3,"#ffd6a5"),t.circle(e,3,"#ffd6a5")}}if(this.path.length>=2){i.lineWidth=3,i.strokeStyle="#7aa2ff",i.beginPath(),i.moveTo(this.path[0].p.x,this.path[0].p.y);for(let s=0;s<this.path.length-1;s++){const n=this.path[s],e=this.path[s+1],r=a(n.p,n.out),h=a(e.p,e.in);i.bezierCurveTo(r.x,r.y,h.x,h.y,e.p.x,e.p.y)}if(this.closed&&this.path.length>2){const s=this.path[this.path.length-1],n=this.path[0],e={x:s.p.x+s.out.x,y:s.p.y+s.out.y},r={x:n.p.x+n.in.x,y:n.p.y+n.in.y};i.bezierCurveTo(e.x,e.y,r.x,r.y,n.p.x,n.p.y)}i.stroke(),this.closed&&this.showControls&&(i.fillStyle="#9aa3c7",i.font="12px ui-sans-serif,system-ui",i.fillText("（已形成封閉路徑）",12,32))}if(this.showControls)for(const s of this.path)t.circle(s.p,5,"#6ee7b7");i.fillStyle="#9aa3c7",i.font="18px ui-sans-serif,system-ui",i.fillText(`模式：${this.mode==="add"?"新增錨點":"編輯"}`,12,18),this.closed&&i.fillText("（已形成封閉路徑）",100,18)}redraw(){this.draw()}pos(t){const i=this.canvas.getBoundingClientRect();return{x:(t.clientX-i.left)*(this.canvas.width/i.width),y:(t.clientY-i.top)*(this.canvas.height/i.height)}}}const y=document.getElementById("canvas"),c=new C(y);document.getElementById("count");document.getElementById("mode-add").addEventListener("click",()=>c.setMode("add"));document.getElementById("mode-edit").addEventListener("click",()=>c.setMode("edit"));document.getElementById("undo").addEventListener("click",()=>c.undo());document.getElementById("clear").addEventListener("click",()=>c.clear());const p=document.getElementById("toggle-controls");p.addEventListener("click",()=>{c.toggleControls(),p.textContent=p.textContent==="HIDE HANDLES"?"SHOW HANDLES":"HIDE HANDLES"});function w(o,t){const i=window.devicePixelRatio||1,s=o.getBoundingClientRect(),n=Math.round(s.width*i),e=Math.round(s.height*i);(o.width!==n||o.height!==e)&&(o.width=n,o.height=e,t())}w(y,()=>c.redraw());window.addEventListener("resize",()=>w(y,()=>c.redraw()));
