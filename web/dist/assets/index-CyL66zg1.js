(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(i){if(i.ep)return;i.ep=!0;const e=n(i);fetch(i.href,e)}})();function a(o,t){return{x:o.x+t.x,y:o.y+t.y}}function w(o,t){return{x:o.x-t.x,y:o.y-t.y}}function l(o,t){return{x:o.x*t,y:o.y*t}}function v(o,t){return Math.hypot(o.x-t.x,o.y-t.y)}function p(o,t){const n=o.x-t.x,s=o.y-t.y;return n*n+s*s}function g(o){return o.x*o.x+o.y*o.y}function x(o){const t=Math.hypot(o.x,o.y)||1;return{x:o.x/t,y:o.y/t}}function k(o,t,n){return Math.max(t,Math.min(n,o))}function E(o){const t=o.getContext("2d");function n(){t.clearRect(0,0,o.width,o.height)}function s(){t.save(),t.globalAlpha=.35,t.lineWidth=1,t.strokeStyle="#1d2448";for(let h=0;h<=o.width;h+=50)t.beginPath(),t.moveTo(h,0),t.lineTo(h,o.height),t.stroke();for(let h=0;h<=o.height;h+=50)t.beginPath(),t.moveTo(0,h),t.lineTo(o.width,h),t.stroke();t.restore()}function i(h,u=3,f="#7aa2ff"){if(h.length){t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let d=1;d<h.length;d++)t.lineTo(h[d].x,h[d].y);t.lineWidth=u,t.strokeStyle=f,t.stroke()}}function e(h,u=2.2,f="#7aa2ff"){t.fillStyle=f;for(const d of h)t.beginPath(),t.arc(d.x,d.y,u,0,Math.PI*2),t.fill()}function r(h,u,f="#6ee7b7"){t.beginPath(),t.arc(h.x,h.y,u,0,Math.PI*2),t.fillStyle=f,t.fill()}return{ctx:t,clear:n,grid:s,polyline:i,points:e,circle:r}}class L{constructor(t){this.canvas=t,this.path=[],this.closed=!1,this.mode="add",this.dragging=null,this.last={x:0,y:0},this.shift=!1,this.bindInput(),this.draw()}setMode(t){this.mode=t,this.draw()}toggleClosed(){this.path.length>=3&&(this.closed=!this.closed,this.draw())}clear(){console.log("CLEAR CALLED"),this.path=[],this.closed=!1,this.draw()}undo(){this.path.length>0&&(this.path.pop(),this.path.length<3&&(this.closed=!1),this.draw())}bindInput(){window.addEventListener("keydown",t=>{t.key==="Shift"&&(this.shift=!0)}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(this.shift=!1)}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("pointerdown",t=>{const n=this.pos(t);if(this.mode==="add"){const s=this.hitTest(n);if(s&&s.kind=="anchor"&&s.index===0&&this.path.length>=3){this.closed=!0,this.mode="edit",this.draw();return}s?this.dragging=s:this.addAnchor(n)}else this.dragging=this.hitTest(n);this.last=n,this.canvas.setPointerCapture(t.pointerId),this.draw()}),this.canvas.addEventListener("pointermove",t=>{if(!this.dragging)return;const n=this.pos(t),s=n.x-this.last.x,i=n.y-this.last.y;if(this.last=n,this.dragging.kind==="anchor"){const e=this.path[this.dragging.index];e.p={x:e.p.x+s,y:e.p.y+i},e.in={x:e.in.x,y:e.in.y},e.out={x:e.out.x,y:e.out.y}}else if(this.dragging.kind==="in"){const e=this.path[this.dragging.index];e.in={x:e.in.x+s,y:e.in.y+i},e.smooth&&(e.out={x:-e.in.x,y:-e.in.y})}else if(this.dragging.kind==="out"){const e=this.path[this.dragging.index];e.out={x:e.out.x+s,y:e.out.y+i},e.smooth&&(e.in={x:-e.out.x,y:-e.out.y})}this.draw()}),this.canvas.addEventListener("pointerup",t=>{this.dragging=null,this.canvas.releasePointerCapture(t.pointerId)}),this.canvas.addEventListener("dblclick",t=>{const n=this.pos(t),s=this.hitTest(n);if(s&&s.kind==="anchor"){const i=this.path[s.index];if(i.smooth=!i.smooth,i.smooth){const e=Math.max(g(i.in),g(i.out))**.5||40,r=x(a(i.out,l(i.in,-1)));i.out=l(r,e),i.in=l(r,-e)}this.draw()}else this.mode="edit"},{passive:!0})}addAnchor(t){if(this.path.length===0)this.path.push({p:t,in:{x:-40,y:0},out:{x:40,y:0},smooth:!0});else{const n=this.path[this.path.length-1],s=x(w(t,n.p)),i=k(v(n.p,t)*.3,30,120),e={p:t,in:l(s,-i),out:l(s,i),smooth:!0};n.smooth&&(n.out=l(s,i)),this.path.push(e)}}hitTest(t){for(let i=this.path.length-1;i>=0;i--){const e=this.path[i];if(p(t,e.p)<=81)return{kind:"anchor",index:i};const r=a(e.p,e.in),h=a(e.p,e.out);if(p(t,r)<=49)return{kind:"in",index:i};if(p(t,h)<=49)return{kind:"out",index:i}}return null}draw(){const t=E(this.canvas),n=t.ctx;t.clear(),t.grid(),n.lineWidth=1.5;for(const s of this.path){const i=a(s.p,s.in),e=a(s.p,s.out);n.strokeStyle="#fca5a5",n.beginPath(),n.moveTo(s.p.x,s.p.y),n.lineTo(i.x,i.y),n.stroke(),n.beginPath(),n.moveTo(s.p.x,s.p.y),n.lineTo(e.x,e.y),n.stroke(),t.circle(i,3,"#ffd6a5"),t.circle(e,3,"#ffd6a5")}if(this.path.length>=2){n.lineWidth=3,n.strokeStyle="#7aa2ff",n.beginPath(),n.moveTo(this.path[0].p.x,this.path[0].p.y);for(let s=0;s<this.path.length-1;s++){const i=this.path[s],e=this.path[s+1],r=a(i.p,i.out),h=a(e.p,e.in);n.bezierCurveTo(r.x,r.y,h.x,h.y,e.p.x,e.p.y)}if(this.closed&&this.path.length>2){const s=this.path[this.path.length-1],i=this.path[0],e={x:s.p.x+s.out.x,y:s.p.y+s.out.y},r={x:i.p.x+i.in.x,y:i.p.y+i.in.y};n.bezierCurveTo(e.x,e.y,r.x,r.y,i.p.x,i.p.y)}n.stroke(),this.closed&&(n.fillStyle="#9aa3c7",n.font="12px ui-sans-serif,system-ui",n.fillText("（已形成封閉路徑）",12,32))}for(const s of this.path)t.circle(s.p,5,"#6ee7b7");n.fillStyle="#9aa3c7",n.font="18px ui-sans-serif,system-ui",n.fillText(`模式：${this.mode==="add"?"新增錨點":"編輯"}`,12,18),this.closed&&n.fillText("（已形成封閉路徑）",100,18)}redraw(){this.draw()}pos(t){const n=this.canvas.getBoundingClientRect();return{x:(t.clientX-n.left)*(this.canvas.width/n.width),y:(t.clientY-n.top)*(this.canvas.height/n.height)}}}const y=document.getElementById("canvas"),c=new L(y);document.getElementById("count");document.getElementById("mode-add").addEventListener("click",()=>c.setMode("add"));document.getElementById("mode-edit").addEventListener("click",()=>c.setMode("edit"));document.getElementById("undo").addEventListener("click",()=>c.undo());document.getElementById("closed").addEventListener("click",()=>c.toggleClosed());document.getElementById("clear").addEventListener("click",()=>c.clear());function m(o,t){const n=window.devicePixelRatio||1,s=o.getBoundingClientRect(),i=Math.round(s.width*n),e=Math.round(s.height*n);(o.width!==i||o.height!==e)&&(o.width=i,o.height=e,t())}m(y,()=>c.redraw());window.addEventListener("resize",()=>m(y,()=>c.redraw()));
